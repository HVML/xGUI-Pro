function checkHVML() {
    console.log(typeof(document.getElementByHVMLHandle));
    console.log(typeof(HVML));
    console.log(HVML.version);

    if (typeof(document.getElementByHVMLHandle) == "function") {
        if (typeof(HVML) == "object" && HVML.version >= @HVMLJS_VERSION@) {
            var elemStatus = document.getElementByHVMLHandle('731128');
            var elemRunner = document.getElementByHVMLHandle('790715');
            if (elemStatus && elemRunner) {
                elemStatus.textContent = 'Ready';
                elemRunner.textContent = '@' + HVML.hostName + '/' + HVML.appName + '/' + HVML.runnerName;
                return true;
            }
            else {
                console.log("A new HVML content loaded");
            }
        }
        else {
            console.log("Make sure to use the correct version of xGUI Pro");
        }
    }
    else {
        console.log("Make sure to use the tailored WebKit released by HVML community and the configuration option `ENABLE_HVML_ATTRS` is ON.");
    }

    return false;
}

if (checkHVML()) {
    HVML.onrequest = function (json) {
        msg = JSON.parse(json);
        console.log("HVML.onrequest called: " + msg.operation);

        if (msg.operation === 'load') {
            document.open();
            document.write(msg.data);
            document.close();
            return { requestId: msg.requestId, state: "Ok" };
        }
        else if (msg.operation === 'writeBegin') {
            document.open();
            document.write(msg.data);
            return { requestId: msg.requestId, state: "Ok" };
        }
        else if (msg.operation === 'writeMore') {
            document.write(msg.data);
            return { requestId: msg.requestId, state: "Ok" };
        }
        else if (msg.operation === 'writeEnd') {
            document.write(msg.data);
            document.close();
            return { requestId: msg.requestId, state: "Ok" };
        }
        else if (msg.operation === 'update') {
            if (msg.elementType === 'handle') {
                var elem = document.getElementByHVMLHandle(msg.element);
                if (elem) {
                    if (!updateProperty(elem, msg.property, msg.data))
                        return { requestId: msg.requestId, state: "BadRequest" };
                }
                else {
                    return { requestId: msg.requestId, state: "NotFound" };
                }
            }
            else if (msg.elementType == 'handles') {
                var handles = msg.element.split(',');
                var nr_updated = 0;
                for (var i = 0; i < handles.length; i++) {
                    var elem = document.getElementByHVMLHandle(handles[i]);
                    if (elem) {
                        if (updateProperty(elem, msg.property, msg.data))
                            nr_updated++;
                    }
                }

                if (nr_updated == 0)
                    return { requestId: msg.requestId, state: "NotFound" };
                else if (nr_updated == handles.length)
                    return { requestId: msg.requestId, state: "Ok" };
                else
                    return { requestId: msg.requestId, state: "PartialContent" };
            }
        }

        return { requestId: msg.requestId, state: "NotImplemented" };
    }
}

function updateProperty(elem, property, data)
{
    if (property === "textContent") {
        elem.textContent = data;
        return true;
    }
    else if (property.startsWith("attr.")) {
        var attr = property.substring(5);
        elem.setAttribute(attr, data);
        return true;
    }

    return false;
}

/*
function onChangePage(msg)
{
    if (msg.operation === 'load') {
        document.open();
        document.write(msg.data);
        document.close();
    }
    else if (msg.operation === 'writeBegin') {
        document.open();
        document.write(msg.data);
    }
    else if (msg.operation === 'writeMore') {
        document.write(msg.data);
    }
    else if (msg.operation === 'writeEnd') {
        document.write(msg.data);
        document.close();
    }

    // check all elements which defined hvml:events and listen the events
}

function onChangeDocument(msg)
{
    var elements;

    if (msg.elementType === 'css') {
        elements = document.querySelectorAll(msg.elementValue);
    }
    else if (msg.elementType === 'handle') {
        elements = document.getElementByHVMLHandle(msg.elementValue);
    }

    if (msg.operation === 'append') {
    }
    else if (msg.operation === 'prepend') {
    }
}

HVML.onrequest = function (msg) {
    log.console();
    if (msg.type === 'request' && msg.target !== 'dom') {
        return onChangePage(msg);
    }

    if (msg.type === 'request' && msg.target === 'dom') {
        if (msg.operation != 'request') {
            return onChangeDocument(msg);
        }
        else if (msg.operation.startsWith('callMethod') {
            return onCallMethod(msg);
        }
    }
}
*/
